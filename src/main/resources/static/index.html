<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartGallery — AI-Powered Image Search</title>
    <meta name="description" content="Offline AI-powered image search using CLIP semantic embeddings" />
    <link rel="stylesheet" href="/app.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>

<body>
    <div id="app">

        <!-- ═══ HEADER ════════════════════════════════════════════════════════ -->
        <header id="header">
            <div class="logo">
                <div class="logo-icon"><span class="material-symbols-outlined">photo_library</span></div>
                <span class="logo-text">SmartGallery</span>
            </div>

            <div id="search-bar">
                <span class="material-symbols-outlined search-icon">search</span>
                <input id="search-input" type="text" placeholder="Search images — try: 'sunset over mountains'"
                    autocomplete="off" />
                <span id="clear-search-btn" class="material-symbols-outlined" title="Clear search"
                    style="display:none;">close</span>
                <label for="visual-search-file-input" id="visual-search-btn" class="material-symbols-outlined"
                    title="Visual search — upload an image">image_search</label>
                <input id="visual-search-file-input" type="file" accept="image/*" style="display:none" />
            </div>

            <div class="header-actions">
                <div id="model-status-badge" class="notready">
                    <span class="dot"></span>
                    <span id="model-status-text">Models Not Ready</span>
                </div>
                <div id="index-status-pill">
                    <span class="material-symbols-outlined" style="font-size:14px">sync</span>
                    <span id="index-pill-text">Indexing...</span>
                </div>
                <button class="icon-btn" id="btn-reindex" title="Re-index all folders">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
                <button class="icon-btn" id="btn-settings" title="Settings" onclick="SmartGallery.openSettings()">
                    <span class="material-symbols-outlined">settings</span>
                </button>
            </div>
        </header>

        <!-- ═══ BODY ══════════════════════════════════════════════════════════ -->
        <div id="body">

            <!-- ─── SIDEBAR ──────────────────────────────────────────────────── -->
            <aside id="sidebar">
                <div class="sidebar-section" style="padding-top:12px">
                    <div class="sidebar-label">Library</div>
                    <button class="sidebar-item active" id="nav-all" onclick="SmartGallery.browse('all')">
                        <span class="material-symbols-outlined">photo_library</span>
                        <span class="label">All Photos</span>
                        <span class="count" id="count-all">0</span>
                    </button>
                    <button class="sidebar-item" id="nav-recent" onclick="SmartGallery.browse('recent')">
                        <span class="material-symbols-outlined">schedule</span>
                        <span class="label">Recent</span>
                    </button>
                    <button class="sidebar-item" id="nav-favorites" onclick="SmartGallery.browse('favorites')">
                        <span class="material-symbols-outlined">star</span>
                        <span class="label">Favorites</span>
                        <span class="count" id="count-favorites">0</span>
                    </button>
                </div>

                <div class="sidebar-divider"></div>

                <div class="sidebar-section">
                    <div
                        style="display:flex;align-items:center;justify-content:space-between;padding:0 8px;margin-bottom:6px">
                        <div class="sidebar-label" style="margin-bottom:0">ALBUMS</div>
                        <button onclick="SmartGallery.openSettings('folders')" style="color:var(--text-dim)"
                            title="Manage folders">
                            <span class="material-symbols-outlined" style="font-size:16px">add</span>
                        </button>
                    </div>
                    <div id="sidebar-folders"></div>
                </div>

                <div class="sidebar-divider"></div>



            </aside>

            <!-- ─── MAIN ─────────────────────────────────────────────────────── -->
            <main id="main">

                <!-- Toolbar -->
                <div id="toolbar">
                    <div class="toolbar-left">
                        <span id="indexed-count"><span id="result-count">0</span> results</span>
                        <div class="filter-chips" id="filter-chips">
                            <button class="filter-chip" data-filter="all" onclick="SmartGallery.setFilter('all',this)">
                                <span class="material-symbols-outlined">grid_view</span> All
                            </button>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <div class="size-slider-wrap">
                            <span class="material-symbols-outlined"
                                style="font-size:16px">photo_size_select_small</span>
                            <input id="thumb-size-slider" type="range" min="1" max="100" value="50"
                                title="Thumbnail size" />
                            <span class="material-symbols-outlined">photo_size_select_large</span>
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" id="view-grid" onclick="SmartGallery.setView('grid')"
                                title="Grid view">
                                <span class="material-symbols-outlined">grid_view</span>
                            </button>
                            <button class="view-btn" id="view-list" onclick="SmartGallery.setView('list')"
                                title="List view">
                                <span class="material-symbols-outlined">view_list</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gallery container -->
                <div id="gallery-container">
                    <!-- Empty state (shown when no results) -->
                    <div id="empty-state" style="display:none">
                        <span class="material-symbols-outlined empty-icon">photo_library</span>
                        <h3 id="empty-title">No images found</h3>
                        <p id="empty-desc">Add images to your watched folders and click the refresh button to index
                            them, or download the CLIP models to enable semantic search.</p>
                        <div style="display:flex;gap:10px;margin-top:12px">
                            <button class="btn-primary btn-sm" onclick="SmartGallery.openSettings()">
                                <span class="material-symbols-outlined">settings</span> Open Settings
                            </button>
                            <button class="btn-secondary btn-sm" onclick="SmartGallery.reindex()">
                                <span class="material-symbols-outlined">refresh</span> Reindex
                            </button>
                        </div>
                    </div>

                    <!-- Loading indicator -->
                    <div id="loading-indicator">
                        <div class="spinner"></div>
                        <span>Searching...</span>
                    </div>

                    <!-- Photo grid -->
                    <div id="gallery-grid"></div>

                    <!-- Infinite scroll sentinel -->
                    <div id="scroll-sentinel"></div>
                </div>
            </main>

            <!-- ─── DETAIL PANEL ──────────────────────────────────────────────── -->
            <aside id="detail-panel">
                <div class="detail-header" style="position:relative;">
                    <div class="detail-filename" id="detail-filename">—</div>
                    <div class="detail-date" id="detail-date">—</div>
                </div>
                <img id="detail-thumb" class="detail-thumb" src="" alt="" style="display:none" />
                <div class="detail-body">
                    <div class="detail-section">
                        <div class="detail-section-label">Similarity</div>
                        <div class="score-bar">
                            <div class="score-bar-fill" id="detail-score-bar"></div>
                        </div>
                        <div style="font-size:11px;color:var(--text-dim);margin-top:4px" id="detail-score-text">—</div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-label">Properties</div>
                        <div class="detail-grid">
                            <span class="detail-key">Size</span><span class="detail-val" id="dp-size">—</span>
                            <span class="detail-key">Dimensions</span><span class="detail-val" id="dp-dims">—</span>
                            <span class="detail-key">Modified</span><span class="detail-val" id="dp-date">—</span>
                            <span class="detail-key">Indexed</span><span class="detail-val" id="dp-indexed">—</span>
                        </div>
                    </div>
                    <div class="detail-section" id="dp-map-section" style="display:none;">
                        <div class="detail-section-label">Location (EXIF)</div>
                        <div id="detail-map"
                            style="width:100%; height:160px; border-radius:8px; margin-top:8px; z-index:1;"></div>
                    </div>
                    <div class="detail-section" id="dp-exif-section" style="display:none;">
                        <div class="detail-section-label">EXIF Details</div>
                        <div class="detail-grid" id="dp-exif-grid"></div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-label">Tags</div>
                        <div class="tags-wrap" id="detail-tags">
                            <span class="tag-add-btn" onclick="SmartGallery.addTagToSelected()">+ Add Tag</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-label">File Path</div>
                        <div style="font-size:10px;color:var(--text-dim);word-break:break-all" id="dp-path">—</div>
                    </div>
                </div>
                <div class="detail-actions">
                    <button class="privacy-toggle-btn" id="privacy-toggle-btn"
                        onclick="SmartGallery.togglePrivacyBlur()" title="Toggle Privacy Blur">
                        <span class="material-symbols-outlined">visibility</span>
                    </button>
                    <button class="btn-secondary btn-sm btn-block" onclick="SmartGallery.findSimilar()"
                        title="Find visually similar images">
                        <span class="material-symbols-outlined" style="font-size:15px">find_replace</span> Similar
                    </button>
                    <button class="btn-danger btn-sm btn-block" onclick="SmartGallery.deleteImage()"
                        title="Delete from Index">
                        <span class="material-symbols-outlined" style="font-size:15px">delete</span> Delete
                    </button>
                </div>
            </aside>

        </div><!-- /#body -->

    </div><!-- /#app -->

    <!-- ═══ DROP ZONE (visual search drag) ═══════════════════════════════ -->
    <div id="drop-zone-overlay">
        <div class="drop-zone-inner">
            <span class="material-symbols-outlined">image_search</span>
            <h3>Drop image to search visually</h3>
        </div>
    </div>

    <!-- ═══ TOAST CONTAINER ══════════════════════════════════════════════ -->
    <div id="toast-container"></div>

    <!-- ═══ SETTINGS MODAL ════════════════════════════════════════════════ -->
    <div id="modal-overlay" onclick="SmartGallery.closeSettings(event)">
        <div id="settings-modal">
            <div class="modal-header">
                <div style="display:flex;align-items:center;gap:10px">
                    <span class="material-symbols-outlined" style="color:var(--primary)">settings</span>
                    <span class="modal-title">Settings</span>
                </div>
                <button class="modal-close" onclick="SmartGallery.closeSettings()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- ── Tabs ── -->
            <div style="display:flex;gap:0;border-bottom:1px solid var(--border);padding:0 24px">
                <button class="modal-tab active" data-tab="models" onclick="SmartGallery.switchTab('models',this)"
                    style="padding:10px 16px;font-size:13px;font-weight:600;color:var(--primary);border-bottom:2px solid var(--primary);background:none;border-top:none;border-left:none;border-right:none;cursor:pointer;margin-bottom:-1px">
                    AI Models
                </button>
                <button class="modal-tab" data-tab="folders" onclick="SmartGallery.switchTab('folders',this)"
                    style="padding:10px 16px;font-size:13px;font-weight:500;color:var(--text-muted);border-bottom:2px solid transparent;background:none;border-top:none;border-left:none;border-right:none;cursor:pointer;margin-bottom:-1px">
                    Folders
                </button>
                <button class="modal-tab" data-tab="advanced" onclick="SmartGallery.switchTab('advanced',this)"
                    style="padding:10px 16px;font-size:13px;font-weight:500;color:var(--text-muted);border-bottom:2px solid transparent;background:none;border-top:none;border-left:none;border-right:none;cursor:pointer;margin-bottom:-1px">
                    Advanced
                </button>
            </div>

            <div class="modal-body">

                <!-- ── Models Tab ── -->
                <div id="tab-models" class="tab-pane modal-cols">
                    <!-- Left: Token + Download -->
                    <div class="modal-col">
                        <div class="form-group">
                            <label class="form-label">Hugging Face Token</label>
                            <input id="hf-token-input" class="form-input" type="password" placeholder="hf_..."
                                autocomplete="off" />
                            <p class="form-hint">Required once for model download. Stored encrypted on this machine.</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Model Repository</label>
                            <input id="hf-repo-input" class="form-input" type="text"
                                value="Xenova/clip-vit-base-patch32" placeholder="owner/repo" />
                            <p class="form-hint">ONNX-format CLIP model repo on Hugging Face</p>
                        </div>
                        <div class="btn-row" style="margin-bottom:16px">
                            <button class="btn-primary btn-sm" onclick="SmartGallery.saveToken()">
                                <span class="material-symbols-outlined" style="font-size:15px">save</span> Save Token
                            </button>
                            <button class="btn-secondary btn-sm" onclick="SmartGallery.clearToken()">
                                <span class="material-symbols-outlined" style="font-size:15px">delete</span> Clear
                            </button>
                        </div>
                        <div class="btn-row">
                            <button class="btn-primary" id="btn-download-models"
                                onclick="SmartGallery.downloadModels()">
                                <span class="material-symbols-outlined">cloud_download</span> Download Models
                            </button>
                            <button class="btn-secondary btn-sm" onclick="SmartGallery.verifyModels()">
                                <span class="material-symbols-outlined" style="font-size:15px">verified</span> Verify
                            </button>
                        </div>
                        <div class="progress-wrap" id="download-progress-wrap" style="display:none">
                            <div class="progress-label">
                                <span id="progress-file-label">Downloading...</span>
                                <span id="progress-pct">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Right: Model status -->
                    <div class="modal-col">
                        <div style="margin-bottom:12px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                                <span class="detail-section-label" style="margin-bottom:0">Model Status</span>
                                <div id="modal-model-badge"
                                    style="font-size:11px;font-weight:700;padding:2px 8px;border-radius:999px;background:var(--active);color:var(--text-dim)">
                                    UNKNOWN</div>
                            </div>
                            <div id="model-files-list"></div>
                        </div>
                        <div class="detail-section-label">Download Log</div>
                        <div id="download-log"></div>
                    </div>
                </div>

                <!-- ── Folders Tab ── -->
                <div id="tab-folders" class="tab-pane" style="display:none;padding:24px">
                    <div style="display:flex;gap:8px;margin-bottom:16px">
                        <input id="new-folder-input" class="form-input" type="text"
                            placeholder="C:\Users\me\Pictures or ./data/images" style="flex:1" />
                        <button class="btn-primary btn-sm" onclick="SmartGallery.addFolder()">
                            <span class="material-symbols-outlined" style="font-size:15px">add</span> Add
                        </button>
                    </div>
                    <div id="folders-list"></div>
                    <p class="form-hint" style="margin-top:12px">
                        Folders are watched continuously. New images added to them are indexed automatically.
                        Multiple folders can be monitored simultaneously.
                    </p>
                </div>

                <!-- ── Advanced Tab ── -->
                <div id="tab-advanced" class="tab-pane" style="display:none;padding:24px">
                    <div style="max-width:540px">

                        <div
                            style="display:flex;justify-content:space-between;align-items:center;padding:0 0 16px;border-bottom:1px solid var(--border)">
                            <div style="flex:1;padding-right:16px">
                                <h4 style="margin:0;font-size:14px;color:var(--text);font-weight:600">Show/Hide EXIF
                                    Data</h4>
                                <p class="form-hint" style="margin:4px 0 0">Show or hide camera info in the image detail
                                    panel.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="exif-visible-toggle"
                                    onchange="SmartGallery.saveAdvancedSettings()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div
                            style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border)">
                            <div style="flex:1;padding-right:16px">
                                <h4 style="margin:0;font-size:14px;color:var(--text);font-weight:600">Show/Hide Map</h4>
                                <p class="form-hint" style="margin:4px 0 0">Show or hide the location map in the detail
                                    panel (Dependent on EXIF).</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="map-visible-toggle"
                                    onchange="SmartGallery.saveAdvancedSettings()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div
                            style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border)">
                            <div style="flex:1;padding-right:16px">
                                <h4 style="margin:0;font-size:14px;color:var(--text);font-weight:600">Extract EXIF
                                    metadata</h4>
                                <p class="form-hint" style="margin:4px 0 0">Parse camera info and GPS data during
                                    indexing.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="exif-parsing-toggle"
                                    onchange="SmartGallery.saveAdvancedSettings()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div
                            style="display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--border)">
                            <div style="flex:1;padding-right:16px">
                                <h4 style="margin:0;font-size:14px;color:var(--text);font-weight:600">Auto Indexing
                                    Enable/Disable</h4>
                                <p class="form-hint" style="margin:4px 0 0">Automatically detect and index changes in
                                    watched folders.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="auto-indexing-toggle"
                                    onchange="SmartGallery.saveAdvancedSettings()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div style="padding:24px 0 12px">
                            <div
                                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <h4 style="margin:0;font-size:14px;color:var(--text);font-weight:600">Search Similarity
                                    Threshold</h4>
                                <span id="threshold-val"
                                    style="font-weight:700;color:var(--primary);font-family:monospace;font-size:14px">0.24</span>
                            </div>
                            <input type="range" id="threshold-slider" min="0.0" max="0.6" step="0.01" value="0.24"
                                style="width:100%;cursor:pointer"
                                oninput="$('#threshold-val').text(parseFloat(this.value).toFixed(2))"
                                onchange="SmartGallery.saveAdvancedSettings()">
                            <div
                                style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-dim);margin-top:8px">
                                <span>Strict (Accurate)</span>
                                <span style="color:var(--green);font-weight:600">Recommended: 0.20 - 0.40</span>
                                <span>Loose (Broad)</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div><!-- /.modal-body -->

        </div>
    </div><!-- /#modal-overlay -->



    <!-- ═══ SCRIPTS ═══════════════════════════════════════════════════════ -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="/app.js"></script>

    <!-- ─── LIGHTBOX PREVIEW (HIDDEN) ─────────────────────────────────── -->
    <div id="lightbox" class="lightbox-overlay" style="display:none;">
        <button class="lightbox-close" onclick="SmartGallery.closeLightbox()">
            <span class="material-symbols-outlined">close</span>
        </button>
        <button class="lightbox-nav lightbox-prev" onclick="SmartGallery.navLightbox(-1)">
            <span class="material-symbols-outlined">chevron_left</span>
        </button>
        <img id="lightbox-img" class="lightbox-img" src="" alt="Full Screen Preview" />
        <button class="lightbox-nav lightbox-next" onclick="SmartGallery.navLightbox(1)">
            <span class="material-symbols-outlined">chevron_right</span>
        </button>
        <div class="lightbox-caption" id="lightbox-caption"></div>
    </div>

</body>

</html>